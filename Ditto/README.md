# Ditto

Ditto is capable of transforming itself into anything perfectly. However, it only knows one move, Transform.

## RESTRICTIONS !!!
Can not run multiple jobs at the same time, if they use HDFS, because filesystem \
is being cached and shared, so 1 job will close filesystem instance for others

## Job Request
Based on the filled **platform** in **sinkGeneral** and **sourceGeneral**, the corresponding object must be filled. \
Other objects that are not the type of the selected platform are ignored, i.e. whether they are filled or not is not important.
### Job Request Examples
[Whole Job Request](docs/JobRequest.json)

[HDFS -> HDFS](docs/requestExamples/HDFS-HDFS.json)\
[HDFS -> Kafka](docs/requestExamples/HDFS-Kafka.json)\
[HDFS -> S3](docs/requestExamples/HDFS-S3.json)\
[HDFS -> Local](docs/requestExamples/HDFS-Local.json)

[Kafka -> Kafka](docs/requestExamples/Kafka-Kafka.json)\
[Kafka -> S3](docs/requestExamples/Kafka-S3.json)\
[Kafka -> HDFS](docs/requestExamples/Kafka-HDFS.json)\
[Kafka -> Local](docs/requestExamples/Kafka-Local.json)

[S3 -> S3](docs/requestExamples/S3-S3.json)\
[S3 -> Kafka](docs/requestExamples/S3-Kafka.json)\
[S3 -> HDFS](docs/requestExamples/S3-HDFS.json)\
[S3 -> Local](docs/requestExamples/S3-Local.json)

### Job Request Description
| Field                      | Type     | Values                          | Meaning                                                                                                                                                                                                                                                                                   |
|----------------------------|----------|---------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| shallBeQueued              | boolean  |                                 | Flag that determines whether you want to add your job to the queue <br/>of pending jobs, if the job cannot be executed immediately                                                                                                                                                        |
| parallelism                | int      |                                 | Determines parallelism if your submitted job. If parallelism is higher <br/>than allowed, Ditto will automatically adjust it. Parallelism might be <br/>higher based on used source type. <br/>Kafka - less partitions than parallelism, <br/>HDFS/S3 - less files found than parallelism |
| sourceGeneral              | object   |                                 | General description of source containing common source params                                                                                                                                                                                                                             |
| sourceGeneral.dataType     | dataType |                                 | Source's data type                                                                                                                                                                                                                                                                        |
| sourceGeneral.platform     | String   | KAFKA, S3, <br/>HDFS            | Source's platform                                                                                                                                                                                                                                                                         |
| sinkGeneral                | object   |                                 |                                                                                                                                                                                                                                                                                           |
| sinkGeneral.dataType       | dataType |                                 |                                                                                                                                                                                                                                                                                           |
| sinkGeneral.platform       | String   | KAFKA, S3, <br/>HDFS, LOCAL_FS  |                                                                                                                                                                                                                                                                                           |
| specialConverter           | object   |                                 | Use for special type of converter (Basic conversion like from proto to JSON or vice versa is done automatically)                                                                                                                                                                          |
| kafkaSource                | object   |                                 | Specific description of kafka source. It order to be used, you <br/>have to specify platform = 'KAFKA' in sourceGeneral                                                                                                                                                                   |
| kafkaSink                  | object   |                                 | Specific description of kafka sink. It order to be used, you <br/>have to specify platform = 'KAFKA' in sinkGeneral                                                                                                                                                                       |
| s3Source                   | object   |                                 | Specific description of s3 source. It order to be used, you <br/>have to specify platform = 'S3' in sourceGeneral                                                                                                                                                                         |
| s3Sink                     | object   |                                 | Specific description of s3 sink. It order to be used, you <br/>have to specify platform = 'S3' in sinkGeneral                                                                                                                                                                             |
| hdfsSource                 | object   |                                 | Specific description of hdfs source. It order to be used, you <br/>have to specify platform = 'HDFS' in sourceGeneral                                                                                                                                                                     |
| hdfsSink                   | object   |                                 | Specific description of hdfs sink. It order to be used, you <br/>have to specify platform = 'HDFS' in sinkGeneral                                                                                                                                                                         |
| localSink                  | object   |                                 | Specific description of local filesystem sink. It order to be used, you <br/>have to specify platform = 'LOCAL_FS' in sourceGeneral                                                                                                                                                       |

#### Objects description
| Name             | Field              | Type     | Optional | Values                                                                                                                                                                                    | Meaning                                                                                                                                                                                                                                                                                              |
|------------------|--------------------|----------|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| dataType         | type               | String   |          | long, int, string, <br/>uuid, json, protobuf                                                                                                                                              | Data Type                                                                                                                                                                                                                                                                                            |
|                  | specificType       | String   | yes      | Video.VideoAd,<br/> Video.ZoneVideo,<br/>Zonestat.ZonestatLogEntry,<br/>Mlrows.Vowpal,<br/>Mlrows.UserHistoryRowLogEntry,<br/>Mlrows.AdFeedbackRowLogEntry,<br/>Mlrows.CoecComputationLog | Specific subtype of dataType. Works only with protobuf,<br/> where you have to define specific proto type by it's <br/>registered name                                                                                                                                                               |
| kafkaSource      | from               | long     |          |                                                                                                                                                                                           | Defines min value of range. Treated based on rangeType                                                                                                                                                                                                                                               |
|                  | to                 | long     |          |                                                                                                                                                                                           | Defines max value of range. Treated based on rangeType                                                                                                                                                                                                                                               |
|                  | rangeType          | String   |          | OFFSET, TIME                                                                                                                                                                              | Defines type of range used to read records. We can either<br/>use timestamp or offset of kafka record.                                                                                                                                                                                               |
|                  | cluster            | String   |          |                                                                                                                                                                                           | Name of registered cluster. Clusters are specified before <br/>start of the application. You can obtain all registered<br/>clusters via endpoint                                                                                                                                                     |
|                  | topic              | String   |          |                                                                                                                                                                                           | Topic                                                                                                                                                                                                                                                                                                |
| kafkaSink        | batchSize          | int      |          |                                                                                                                                                                                           | Because sending every record one by one could be inefficient,<br/>you have to configure batch sizes. Every parallel pipeline<br/>of youe job will sink to every existing partition of defined topic.<br/>This param defines batch size, which will be send in round-robin<br/>fashion to partitions. |
|                  | cluster            | String   |          |                                                                                                                                                                                           | Name of registered cluster. Clusters are specified before <br/>start of the application. You can obtain all registered<br/>clusters via endpoint                                                                                                                                                     |
|                  | topic              | String   |          |                                                                                                                                                                                           | Topic                                                                                                                                                                                                                                                                                                |
| s3Source         | server             | String   |          |                                                                                                                                                                                           | Names of registered S3 server. All names can be obtained<br/>via HTTP endpoint.                                                                                                                                                                                                                      |
|                  | bucket             | String   |          |                                                                                                                                                                                           | Name of existing bucket within server                                                                                                                                                                                                                                                                |
|                  | objectNamePrefixes | [String]      | yes      |                                                                                                                                                                                           | Narrowing the selection of objects based on the prefixes                                                                                                                                                                                                                                             |
|                  | from               | long     | yes      |                                                                                                                                                                                           | from timestamp                                                                                                                                                                                                                                                                                       |
|                  | to                 | long     | yes      |                                                                                                                                                                                           | to timestamp                                                                                                                                                                                                                                                                                         |
| s3Sink           | server             | String   |          |                                                                                                                                                                                           | Names of registered S3 server. All names can be obtained<br/>via HTTP endpoint.                                                                                                                                                                                                                      |
|                  | bucket             | object   |          |                                                                                                                                                                                           | Name of existing bucket within server                                                                                                                                                                                                                                                                |
|                  | fileSegmentator    | object   |          |                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                      |
| hdfsSource       | cluster            | String   |          |                                                                                                                                                                                           | Names of registered HDFS cluster. All names can be obtained<br/>via HTTP endpoint.                                                                                                                                                                                                                   |
|                  | parentPath         | String   |          |                                                                                                                                                                                           | Path to be scanned                                                                                                                                                                                                                                                                                   |
|                  | recursive          | boolean  | yes      |                                                                                                                                                                                           | Flag determining whether you want to scan only 1st level of <br/>defined path, or scan it recursively                                                                                                                                                                                                |
|                  | prefixes           | [String] | yes      |                                                                                                                                                                                           | List of allowed file name prefixes                                                                                                                                                                                                                                                                   |
|                  | from               | long     | yes      |                                                                                                                                                                                           | from timestamp                                                                                                                                                                                                                                                                                       |
|                  | to                 | long     | yes      |                                                                                                                                                                                           | to timestamp                                                                                                                                                                                                                                                                                         |
| hdfsSink         | cluster            | String   |          |                                                                                                                                                                                           | Names of registered HDFS cluster. All names can be obtained<br/>via HTTP endpoint.                                                                                                                                                                                                                   |
|                  | parentPath         | String   |          |                                                                                                                                                                                           | Path where accumulated files will be saved                                                                                                                                                                                                                                                           |
|                  | fileSegmentator    | object   |          |                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                      |
| localSink        | dir                |          |          |                                                                                                                                                                                           | Path where accumulated files will be saved                                                                                                                                                                                                                                                           |
|                  | fileSegmentator    |          |          |                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                      |
| fileSegmentator  | maxSizePerFile     | String   | one of   | String representation of size <br/>in B/Kb/Mb/Gb/Tb. <br/>For example: '1 mb', '456 kb', '2 GB'                                                                                           | Maximal allowed size of file. If maxElements is also defined, then first condition fulfilled will be used                                                                                                                                                                                            |
|                  | maxElementsPerFile | int      | one of   |                                                                                                                                                                                           | Maximal allowed elements per file. If maxSize is also defined, then first condition fulfilled will be used                                                                                                                                                                                           |
| specialConverter | name               | String   | yes      |                                                                                                                                                                                           | Name under which is converter registereg                                                                                                                                                                                                                                                             |
|                  | specificType       | String   | yes      |                                                                                                                                                                                           | Specific type on converter if it has any more specific types                                                                                                                                                                                                                                         |
|                  | args               | [object] | yes      |                                                                                                                                                                                           | array or arguments if converter needs any                                                                                                                                                                                                                                                            |

## Special Converters
Special converters are described using object **specialConverter** in jobRequest.\
You can obtain Map of registered converters via endpoint /api/v1/info/converters

| name            | specificType                                           | args                                |
|-----------------|--------------------------------------------------------|-------------------------------------|
| proto-flat-json | not optional, have to be one of: <br/>video_ad_flatted | null                                |


## REGISTRATION
For now. Every protobuf type of json flatmap schema has to be defined before startup.

### Protobuf
Because ProtoParquetWriter needs to have class found on classpath(no way to use just descriptor) every protobuf has to be \
registered in code. So when adding new proto, change to code has to be done. \
In order to register new protobuf. You have to add new ProtobufRegisterInfo to supplied list in [register](src/main/java/com/bilik/ditto/api/protoRegister/FirstRegistrar.java) method.\
Protobuf's class and name has to be supplied. This name has to be unique and will be used to distinguish this proto.\
Why classname isn't used as a name ? Becasue **VideoAd** looks better than **whole.path.to.proto$VideoAd**

### Json Flatmap Schemas
Schemas for flatmapping to Json should be placed under resources/JsonFlatMaps. Name of file is used as name of schema.
    
## API Errors
Error object is normalized across every REST endpoint. Structure can be found in [Error JSON](docs/ErrorObject.json)


